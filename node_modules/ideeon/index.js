var db		= require('oracledb');
var crypto	= require('crypto');

// set autoCommit true
db.autoCommit = true;

// Connect info object!!
var connectionInfo = {
	user			: "",
	password		: "",
	connectString	: ""
}

// password encryption method
var encrypt = function(data) {
	return crypto.createHash('sha1').update(data).digest('hex');
}

// connection release macro method
var release = function(conn) {
	conn.release(function(err) {
		if( err ) {
			console.log("critic!!: Disconnection of oracledb is failed");
			return false;
		}
	});
}

var signup = function(data, callback) {
	if( !data['email'] || !data['password'] ) {
		callback(new Error("email or password are omitted!!"));
		return false;
	} else if ( data['password'] != data['passwordconfirm'] ) {
		callback(new Error("password are not same with password confirm!!"));
		return false;
	}


    db.getConnection(connectionInfo, function(err, connection) {
		if (err) { 
			callback(err);
			return false;
		}

		var query = "insert into memeber(m_email, m_pw, m_birth) values('"+data.email+"', '"+encrypt(data.password)+"', '"+data.birth+"')";
		connection.execute(query, function(err, result) {
			callback(err);
			release(connection);
		});
	});
}

var login = function(data, callback) {
	if( !data['email'] || !data['password'] ) {
		callback(new Error("email or password are omitted!!"));
		return false;
	}

	db.getConnection(connectionInfo, function(err, connection) {
		if (err) {
			callback(err);
			return false;
		}

		var query = "select m_pw from memeber where m_email='"+data.email+"'";
		connection.execute(query, function(err, result) {
			if( err ) {
				callback(err);
				return false;
			}

			if( encrypt(data.password) == result.rows.toString() ) {
				callback();
			} else {
				callback(new Error("Password isn't matched!!!"));
			}
		});
	});
}

module.exports = {
    signup: signup,
	login: login
}
